commands:
  - name: "clone"
    short: "clone a git repo from account"
    args:
      - name: name
        usage: "repository name"
        required: true
    flags:
      - name: email
        usage: "signature email"
        required: false
        default: "realfabecker@outlook.com"
      - name: account
        usage: "github account url"
        required: false
        default: git@realfabecker.github.com:realfabecker
    cmd: |
      set -e

      echo "Cloning git repository from account...."
      git clone {{ .GetFlag "account" }}/{{ .GetArg "name" }}.git

      echo "Configuring git commit signature..."
      (cd {{ .GetArg "name" }} && kevin gpg git {{ .GetFlag "email" }})
    shell: "/bin/bash"

  - name: "hotfix"
    short: "manutenção de branchs em contexto de hotfix"
    commands:
      - name: "create:branch"
        short: "cria a branch para contexto de hotfix"
        flags:
          - name: name
            usage: "nome do branch a ser criado a partir do hotfix"
            required: true
        cmd: |
          base_remote=origin
          hotfix_name={{ .GetFlag "name" }}

          release_filter="$base_remote/release-*26"

          echo "[INF] Consultando os releases do projeto $release_filter..."
          release_date=$(git branch -r --list "$release_filter" | grep -v $(date +'%d%m%y') | sed -s -E 's/origin\/release\-([0-9]{2})([0-9]{2})([0-9]{2})/20\3-\2-\1/g' | sort -r | awk 'NR==1' | xargs -I{} date -d {} +'%d%m%y')

          base_branch="release-$release_date"

          echo "[INF] Obtendo referencias da branch base $base_remote/$base_branch..."
          git fetch --quiet origin $base_branch

          hotfix_branch="$base_branch-$hotfix_name"

          echo "[INF] Checando se a branch já não existe na origem $hotfix_branch..."
          if [[ -n $(git ls-remote --quiet --heads --no-refs origin "$hotfix_branch") ]]; then
            echo "[ERR] Não é possível criar a branch $branch_name pois elá já existe na origem remota"
            exit 0
          fi;

          echo "[INF] Criando a branch $hotfix_branch..."
          git checkout -b $hotfix_branch -t "$base_remote/$base_branch"

          echo "[INF] Publicando a branch $hotfix_branch no remoto..."
          git push -u origin $hotfix_branch
        
      - name: "create:pr"
        short: "Cria as pull request para o pr hotfix"
        cmd: |          
          if ! git branch --show-current | grep -E release-[0-9]{6}; then 
              echo "[ERR] Não é possível criar o pull request. A branch deve ser prefixada com dominio release"
              exit 0
          fi

          echo "[INF] Criando pull request para o ambiente develop..."
          gh pr create --base develop --fill-first

          echo "[INF] Criando pull request para o ambiente master..."
          gh pr create --base master --fill-first

          echo "[INF] Criando pull request para o ambiente release..."                    
          release_date=$(git branch -r --list "origin/release-*26" | sed -s -E 's/origin\/release\-([0-9]{2})([0-9]{2})([0-9]{2})/20\3-\2-\1/g' | sort -r | awk 'NR==1' | xargs -I{} date -d {} +'%d%m%y')

          release_branch="release-$release_date"

          echo "[INF] Criando pull request para o ambiente $release_branch..."
          gh pr create --base "release-$release_date" --fill-first
